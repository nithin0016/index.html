import React, { useState, useRef, useEffect } from 'react';

const ServoControls = () => {
  const [servoAngles, setServoAngles] = useState([0, 0, 0, 0, 0]);
  const knobRefs = useRef([]);

  // Convert angle to percentage (0-100)
  const angleToPercentage = (angle) => {
    return Math.round(((angle + 120) / 240) * 100);
  };

  // Generate tick marks
  const generateTicks = () => {
    const ticks = [];
    for (let i = -120; i <= 120; i += 5) {
      const isMainTick = i % 30 === 0;
      const tickLength = isMainTick ? 8 : 5;
      const radians = ((i + 120) * Math.PI) / 180;
      const innerRadius = 42;
      const outerRadius = innerRadius + tickLength;
      
      const x1 = innerRadius * Math.cos(radians);
      const y1 = innerRadius * Math.sin(radians);
      const x2 = outerRadius * Math.cos(radians);
      const y2 = outerRadius * Math.sin(radians);
      
      ticks.push(
        <line
          key={i}
          x1={x1}
          y1={y1}
          x2={x2}
          y2={y2}
          className={`stroke-purple-300 ${isMainTick ? 'stroke-2' : 'stroke-1'}`}
          strokeLinecap="round"
        />
      );

      // Add percentage labels for main ticks
      if (isMainTick) {
        const labelRadius = outerRadius + 8;
        const percentage = Math.round(((i + 120) / 240) * 100);
        ticks.push(
          <text
            key={`label-${i}`}
            x={labelRadius * Math.cos(radians)}
            y={labelRadius * Math.sin(radians)}
            className="text-xs fill-purple-400 font-medium"
            textAnchor="middle"
            dominantBaseline="middle"
          >
            {percentage}
          </text>
        );
      }
    }
    return ticks;
  };

  const handleMouseDown = (index, e) => {
    const knob = knobRefs.current[index];
    const rect = knob.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;

    const handleMouseMove = (e) => {
      const deltaX = e.clientX - centerX;
      const deltaY = e.clientY - centerY;
      let angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
      
      angle = (angle + 360) % 360;
      if (angle > 120 && angle < 240) {
        angle = 120;
      } else if (angle >= 240) {
        angle = -120;
      }

      const newAngles = [...servoAngles];
      newAngles[index] = angle;
      setServoAngles(newAngles);
    };

    const handleMouseUp = () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
  };

  const handleReset = () => {
    setServoAngles([0, 0, 0, 0, 0]);
  };

  return (
    <div className="min-h-screen bg-gray-100 p-8">
      <div className="max-w-6xl mx-auto">
        <h1 className="text-3xl font-bold text-purple-800 mb-8">Servo Motor Controls</h1>
        
        <div className="grid grid-cols-2 gap-8">
          {servoAngles.map((angle, index) => (
            <div key={index} className="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center">
              <h2 className="text-xl font-semibold text-purple-600 mb-4">Servo {index + 1}</h2>
              <div className="relative w-64 h-64">
                <svg 
                  viewBox="-60 -60 120 120" 
                  className="w-full h-full"
                >
                  {/* Tick marks */}
                  <g>{generateTicks()}</g>
                  
                  {/* Knob with gradient */}
                  <defs>
                    <radialGradient id={`knobGradient${index}`}>
                      <stop offset="0%" stopColor="#F3E8FF" /> {/* purple-100 */}
                      <stop offset="100%" stopColor="#A855F7" /> {/* purple-500 */}
                    </radialGradient>
                  </defs>
                  
                  <g
                    ref={el => knobRefs.current[index] = el}
                    transform={`rotate(${angle})`}
                    onMouseDown={(e) => handleMouseDown(index, e)}
                    className="cursor-grab"
                  >
                    <circle
                      r="35"
                      fill={`url(#knobGradient${index})`}
                      className="drop-shadow-lg"
                    />
                    {/* Indicator dot */}
                    <circle
                      cy="-30"
                      r="3"
                      className="fill-white"
                    />
                  </g>
                  
                  {/* Current percentage display */}
                  <text
                    className="text-lg font-bold fill-purple-800"
                    textAnchor="middle"
                    dominantBaseline="middle"
                  >
                    {angleToPercentage(angle)}%
                  </text>
                </svg>
              </div>
            </div>
          ))}
        </div>
        
        <button
          onClick={handleReset}
          className="mt-8 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
        >
          Reset All Servos
        </button>
      </div>
    </div>
  );
};

export default ServoControls;
